# --- Stage 1: Build Node.js app ---
FROM node:22-slim AS builder

WORKDIR /app
COPY package.json package-lock.json ./
RUN npm ci --production=false

COPY tsconfig.json ./
COPY src/ ./src/

RUN npm run build

# --- Stage 2: Runtime with Ollama + Node.js ---
FROM ubuntu:22.04

# Prevent interactive prompts during installation
ENV DEBIAN_FRONTEND=noninteractive

# Install system dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    curl \
    ca-certificates \
    gnupg \
    zstd \
    && rm -rf /var/lib/apt/lists/*

# Install Node.js 22
RUN curl -fsSL https://deb.nodesource.com/setup_22.x | bash - \
    && apt-get install -y --no-install-recommends nodejs \
    && rm -rf /var/lib/apt/lists/*

# Install Ollama
RUN curl -fsSL https://ollama.com/install.sh | sh

# --- Copy Node.js app ---
WORKDIR /app

COPY package.json package-lock.json ./
RUN npm ci --omit=dev

COPY --from=builder /app/dist ./dist
COPY public/ ./public/

# --- Pre-load Ollama model during build ---
# Downloads qwen2.5:3b into the image (~2GB)
# May take 10-60+ min depending on internet speed
RUN ollama serve & \
    OLLAMA_PID=$! && \
    echo "Waiting for Ollama to start..." && \
    for i in $(seq 1 60); do \
      curl -sf http://localhost:11434/api/tags > /dev/null 2>&1 && break; \
      echo "  Attempt $i/60..."; \
      sleep 5; \
    done && \
    echo "Ollama ready. Downloading model qwen2.5:3b..." && \
    ollama pull qwen2.5:3b && \
    echo "Model downloaded successfully." && \
    kill $OLLAMA_PID && \
    wait $OLLAMA_PID 2>/dev/null || true

# --- Copy entrypoint ---
COPY entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# Expose ports: 4000 (Node app) + 11434 (Ollama)
EXPOSE 4000 11434

# Default environment variables
ENV PORT=4000
ENV OLLAMA_URL=http://localhost:11434
ENV OLLAMA_MODEL=qwen2.5:3b

ENTRYPOINT ["/entrypoint.sh"]
