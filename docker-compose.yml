version: '3.8'

services:
  # BlindsBook Receptionist IA (Node.js + Ollama + qwen2.5:3b)
  blindsbook-ia:
    build:
      context: .
      dockerfile: Dockerfile.unified
    ports:
      - "4000:4000"      # App Node.js
      - "11434:11434"    # Ollama API (debug/health checks)
    environment:
      - PORT=4000
      - BLINDSBOOK_API_BASE_URL=${BLINDSBOOK_API_BASE_URL:-http://host.docker.internal:3000}
      - BLINDSBOOK_API_TOKEN=${BLINDSBOOK_API_TOKEN:-}
      - BLINDSBOOK_LOGIN_EMAIL=${BLINDSBOOK_LOGIN_EMAIL:-}
      - BLINDSBOOK_LOGIN_PASSWORD=${BLINDSBOOK_LOGIN_PASSWORD:-}
      - TWILIO_AUTH_TOKEN=${TWILIO_AUTH_TOKEN:-}
      - TWILIO_NUMBER_TO_COMPANY_MAP=${TWILIO_NUMBER_TO_COMPANY_MAP:-}
      - TWILIO_VALIDATE_SIGNATURE=false
      - PUBLIC_BASE_URL=${PUBLIC_BASE_URL:-http://localhost:4000}
      - DOCKER_TTS_URL=${DOCKER_TTS_URL:-}
      - OLLAMA_URL=http://localhost:11434
      - OLLAMA_MODEL=${OLLAMA_MODEL:-qwen2.5:3b}
      - AZURE_SPEECH_KEY=${AZURE_SPEECH_KEY:-}
      - AZURE_SPEECH_REGION=${AZURE_SPEECH_REGION:-}
    volumes:
      - ollama_data:/root/.ollama
    deploy:
      resources:
        limits:
          memory: 6G
    restart: unless-stopped

  # Piper TTS (uncomment for separate local TTS)
  # blindsbook-tts:
  #   image: blindsbook-tts:latest
  #   ports:
  #     - "8000:8000"
  #   restart: unless-stopped
  # Note: OCR (POST /ocr/window-frame) is served from blindsbook-ia on port 4000.
  # Drapery Calculator app uses VITE_BLINDSBOOK_IA_URL=http://localhost:4000

volumes:
  ollama_data:
