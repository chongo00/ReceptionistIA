<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BlindsBook â€” Simulador de Llamada IA</title>
<style>
  :root { --bg:#0a0f1a; --card:#141c2e; --accent:#3b82f6; --green:#22c55e; --red:#ef4444; --yellow:#eab308; --text:#e2e8f0; --mute:#94a3b8; --border:#2d3a50; --dark:#0d1220; }
  * { box-sizing:border-box; margin:0; padding:0; }
  body { font-family:'Segoe UI',system-ui,-apple-system,sans-serif; background:var(--bg); color:var(--text); min-height:100vh; display:flex; flex-direction:column; align-items:center; padding:16px; }

  .header { text-align:center; margin-bottom:16px; }
  .header h1 { font-size:1.4rem; display:flex; align-items:center; justify-content:center; gap:10px; }
  .header h1 .phone-icon { font-size:1.6rem; animation: ring 2s ease-in-out infinite; }
  @keyframes ring { 0%,20%,50%,80%,100%{transform:rotate(0)} 10%{transform:rotate(12deg)} 30%{transform:rotate(-10deg)} 40%{transform:rotate(8deg)} }
  .header .subtitle { color:var(--mute); font-size:.8rem; margin-top:4px; }

  .panel { background:var(--card); border-radius:14px; padding:18px; width:100%; max-width:720px; margin-bottom:12px; border:1px solid var(--border); }
  .panel h2 { font-size:.95rem; margin-bottom:10px; color:var(--accent); display:flex; align-items:center; gap:8px; }

  .dialer-row { display:flex; gap:8px; }
  .dialer-row input { flex:1; background:#1a2440; border:1px solid var(--border); color:var(--text); padding:12px 16px; border-radius:10px; font-size:1.1rem; letter-spacing:1px; font-weight:600; }
  .dialer-row input::placeholder { color:#4a5568; font-weight:400; letter-spacing:0; }

  .btn { border:none; padding:10px 22px; border-radius:10px; font-size:.9rem; font-weight:600; cursor:pointer; transition:all .15s; display:inline-flex; align-items:center; gap:8px; }
  .btn-call { background:var(--green); color:#fff; padding:12px 28px; font-size:1rem; }
  .btn-call:hover { background:#16a34a; transform:scale(1.02); }
  .btn-call:disabled { opacity:.4; cursor:not-allowed; transform:none; }
  #dialerStatus { font-size:.8rem; color:var(--mute); margin-top:8px; min-height:18px; }
  #dialerStatus.searching { color:var(--yellow); }
  #dialerStatus.found { color:var(--green); }
  #dialerStatus.notfound { color:var(--red); }
  #dialerStatus.connecting { color:var(--accent); }

  .customer-info { display:none; margin-top:10px; background:var(--dark); border:1px solid var(--border); border-radius:10px; padding:12px 16px; }
  .customer-info.visible { display:block; animation: fadeIn .3s ease; }
  .ci-header { display:flex; justify-content:space-between; align-items:center; }
  .ci-name { font-size:1rem; color:var(--green); font-weight:600; }
  .ci-badge { background:var(--accent); color:#fff; padding:2px 10px; border-radius:12px; font-size:.7rem; font-weight:600; }
  .ci-grid { display:grid; grid-template-columns:1fr 1fr 1fr; gap:4px 16px; margin-top:8px; }
  .ci-grid .cf { font-size:.78rem; }
  .ci-grid .cf .lbl { color:var(--mute); font-size:.65rem; text-transform:uppercase; letter-spacing:.5px; }
  .ci-grid .cf .val { color:var(--text); font-weight:500; }
  .ci-grid .cf .val.hl { color:var(--accent); }
  @keyframes fadeIn { from{opacity:0;transform:translateY(6px)} to{opacity:1;transform:none} }

  .call-screen { display:none; }
  .call-screen.active { display:block; }

  .lang-selector { text-align:center; padding:20px 0; }
  .lang-selector .lang-hint { color:var(--text); font-size:.95rem; margin-bottom:16px; font-weight:500; }
  .lang-buttons { display:flex; gap:14px; justify-content:center; }
  .btn-lang { padding:16px 36px; font-size:1rem; font-weight:700; border-radius:12px; border:2px solid var(--border); background:#1a2440; color:var(--text); cursor:pointer; transition:all .2s; min-width:180px; }
  .btn-lang:hover { border-color:var(--accent); background:#1e3a5f; transform:translateY(-2px); }
  .btn-lang:disabled { opacity:.3; cursor:not-allowed; transform:none; }
  .btn-lang .flag { font-size:1.8rem; display:block; margin-bottom:6px; }

  .status-bar { text-align:center; padding:10px; border-radius:10px; font-size:.85rem; font-weight:500; margin-bottom:6px; }
  .status-bar.idle { background:#1a2440; color:var(--mute); }
  .status-bar.listening { background:#14532d; color:#4ade80; border:1px solid #22c55e44; }
  .status-bar.speaking { background:#1e3a5f; color:#60a5fa; border:1px solid #3b82f644; }
  .status-bar.processing { background:#422006; color:#fbbf24; }
  .status-bar.error { background:#450a0a; color:#fca5a5; }
  .status-bar.ringing { background:#1e3a5f; color:#60a5fa; animation: pulse-ring 1.5s infinite; }
  @keyframes pulse-ring { 0%,100%{opacity:1} 50%{opacity:.6} }

  .state-chips { display:flex; gap:6px; flex-wrap:wrap; font-size:.72rem; margin-top:4px; margin-bottom:8px; justify-content:center; }
  .state-chips .chip { background:#1a2440; padding:3px 8px; border-radius:4px; border:1px solid var(--border); }
  .state-chips .chip b { color:var(--accent); }

  /* â”€â”€â”€ Call Active Area â”€â”€â”€ */
  .call-active-area { display:none; text-align:center; padding:10px 0; }
  .call-active-area.visible { display:block; }

  .mic-indicator { display:flex; align-items:center; justify-content:center; gap:10px; margin-bottom:12px; padding:8px 16px; border-radius:10px; font-size:.85rem; font-weight:500; }
  .mic-indicator.listening { background:#14532d55; color:#4ade80; border:1px solid #22c55e33; }
  .mic-indicator.speaking { background:#1e3a5f55; color:#60a5fa; border:1px solid #3b82f633; }
  .mic-indicator.processing { background:#42200655; color:#fbbf24; border:1px solid #eab30833; }
  .mic-indicator.paused { background:#1a244055; color:var(--mute); border:1px solid var(--border); }

  .sound-wave { display:inline-flex; align-items:center; gap:2px; height:18px; }
  .sound-wave .bar { width:3px; background:currentColor; border-radius:2px; animation:wave 0.8s ease-in-out infinite; }
  .sound-wave .bar:nth-child(1) { height:6px; animation-delay:0s; }
  .sound-wave .bar:nth-child(2) { height:12px; animation-delay:0.1s; }
  .sound-wave .bar:nth-child(3) { height:18px; animation-delay:0.2s; }
  .sound-wave .bar:nth-child(4) { height:12px; animation-delay:0.3s; }
  .sound-wave .bar:nth-child(5) { height:6px; animation-delay:0.4s; }
  @keyframes wave { 0%,100%{transform:scaleY(0.4)} 50%{transform:scaleY(1)} }

  .interim-text { font-size:.8rem; color:#4ade80; font-style:italic; min-height:22px; margin-bottom:10px; padding:0 20px; word-break:break-word; }

  .btn-hangup-big { width:80px; height:80px; border-radius:50%; border:none; background:var(--red); color:#fff; font-size:2rem; cursor:pointer; transition:all .2s; display:inline-flex; align-items:center; justify-content:center; box-shadow:0 4px 20px #ef444444; }
  .btn-hangup-big:hover { background:#dc2626; transform:scale(1.08); box-shadow:0 6px 30px #ef444466; }
  .hangup-label { font-size:.78rem; color:var(--red); margin-top:8px; font-weight:500; }

  /* â”€â”€â”€ Text fallback â”€â”€â”€ */
  .text-fallback { margin-top:12px; display:none; }
  .text-fallback.visible { display:block; }
  .text-fallback-toggle { background:transparent; border:none; color:var(--mute); font-size:.72rem; cursor:pointer; text-decoration:underline; }
  .text-fallback-toggle:hover { color:var(--text); }
  .text-input-row { display:flex; gap:8px; margin-top:6px; }
  .text-input-row input { flex:1; background:#1a2440; border:1px solid var(--border); color:var(--text); padding:10px 14px; border-radius:10px; font-size:.9rem; }
  .btn-sm { padding:6px 14px; font-size:.78rem; border-radius:8px; }
  .btn-primary { background:var(--accent); color:#fff; }
  .btn-primary:hover { background:#2563eb; }

  /* Debug panel */
  .debug-panel { background:#0d1220; border:1px solid var(--border); border-radius:8px; padding:8px 12px; margin-top:8px; font-size:.72rem; font-family:monospace; max-height:120px; overflow-y:auto; }
  .debug-panel .dbg-line { padding:1px 0; color:var(--mute); border-bottom:1px solid #1a2440; }
  .debug-panel .dbg-line.ok { color:#4ade80; }
  .debug-panel .dbg-line.warn { color:#fbbf24; }
  .debug-panel .dbg-line.err { color:#f87171; }
  .mic-test-btn { background:#1a2440; border:1px solid var(--border); color:var(--accent); padding:6px 14px; border-radius:8px; font-size:.75rem; cursor:pointer; margin-top:6px; }
  .mic-test-btn:hover { border-color:var(--accent); background:#1e3a5f; }

  .transcript { max-height:380px; overflow-y:auto; padding:6px 0; min-height:60px; }
  .transcript::-webkit-scrollbar { width:4px; }
  .transcript::-webkit-scrollbar-thumb { background:var(--border); border-radius:4px; }
  .msg { margin-bottom:10px; padding:10px 14px; border-radius:12px; max-width:85%; line-height:1.5; font-size:.88rem; }
  .msg.user { background:#1a2440; margin-left:auto; text-align:right; border-bottom-right-radius:3px; border:1px solid var(--border); }
  .msg.ia { background:#0d2847; border-bottom-left-radius:3px; border:1px solid #1e3a5f; }
  .msg.system { background:transparent; text-align:center; color:var(--mute); font-size:.78rem; border:1px dashed var(--border); max-width:100%; }
  .msg .meta { font-size:.65rem; color:var(--mute); margin-top:4px; }
  .msg .speaker { font-size:.7rem; font-weight:600; margin-bottom:3px; }
  .msg.user .speaker { color:var(--green); }
  .msg.ia .speaker { color:var(--accent); }

  .controls-row { display:flex; justify-content:center; gap:10px; align-items:center; margin-top:6px; }
  .btn-danger { background:var(--red); color:#fff; }
  .btn-ghost { background:transparent; border:1px solid var(--border); color:var(--mute); }
  .btn-ghost:hover { border-color:var(--accent); color:var(--text); }

  .settings-toggle { text-align:center; }
  .settings-toggle button { background:transparent; border:none; color:var(--mute); font-size:.78rem; cursor:pointer; padding:4px 12px; }
  .settings-toggle button:hover { color:var(--text); }
  .settings-body { display:none; }
  .settings-body.open { display:block; margin-top:8px; }
  .settings-body .row { display:flex; gap:8px; align-items:center; margin-bottom:6px; font-size:.82rem; }
  .settings-body .row label { color:var(--mute); min-width:80px; }
  .settings-body .row input, .settings-body .row select { flex:1; background:#1a2440; border:1px solid var(--border); color:var(--text); padding:6px 10px; border-radius:6px; font-size:.82rem; }

  .call-timer { font-size:.75rem; color:var(--mute); text-align:center; font-variant-numeric:tabular-nums; margin-bottom:6px; }
  .call-timer.active { color:var(--green); }

  .live-fields { margin-top:8px; padding-top:8px; border-top:1px solid var(--border); }
  .live-fields .cf .lbl { color:#22c55e !important; }

  .finished-overlay { display:none; text-align:center; padding:24px; }
  .finished-overlay.visible { display:block; animation:fadeIn .5s ease; }
  .finished-overlay .check { font-size:3rem; }
  .finished-overlay h3 { color:var(--green); margin:8px 0; }
  .finished-overlay p { color:var(--mute); font-size:.85rem; line-height:1.6; }
</style>
</head>
<body>

<!-- HEADER -->
<div class="header">
  <h1><span class="phone-icon">ğŸ“</span> BlindsBook â€” Simulador de Llamada</h1>
  <p class="subtitle">Llamada real simulada â€” habla naturalmente, la IA escucha y responde en tiempo real</p>
</div>

<!-- SETTINGS -->
<div class="panel" style="padding:8px 18px;">
  <div class="settings-toggle">
    <button onclick="toggleSettings()">âš™ï¸ ConfiguraciÃ³n avanzada â–¾</button>
  </div>
  <div class="settings-body" id="settingsBody">
    <div class="row">
      <label>Servidor:</label>
      <input type="text" id="serverUrl" value="http://localhost:4000" />
    </div>
    <div class="row">
      <label>CompaÃ±Ã­a:</label>
      <select id="companySelect">
        <option value="">â€” Auto (del lookup) â€”</option>
        <option value="+15550000001">CompaÃ±Ã­a 2 â€” All Blinds Inc</option>
        <option value="+15550000002">CompaÃ±Ã­a 163 â€” Sophie Blinds LLC</option>
        <option value="+15550000003">CompaÃ±Ã­a 387 â€” Miami's Best Blinds</option>
      </select>
    </div>
    <div class="row">
      <label>Caller ID:</label>
      <input type="text" id="callerPhone" value="" placeholder="Se auto-configura al buscar cliente" />
    </div>
  </div>
</div>

<!-- PHONE DIALER -->
<div class="panel" id="dialerPanel">
  <h2>ğŸ“± Marcar nÃºmero del cliente</h2>
  <div class="dialer-row">
    <input type="text" id="customerPhone" placeholder="Ej: 305-123-4567"
           onkeydown="if(event.key==='Enter')startCall()" autocomplete="off" />
    <button class="btn btn-call" id="btnCall" onclick="startCall()">ğŸ“ Llamar</button>
  </div>
  <div id="dialerStatus"></div>
  <div class="customer-info" id="customerInfo">
    <div class="ci-header">
      <span class="ci-name" id="ciName">â€”</span>
      <span class="ci-badge" id="ciBadge">â€”</span>
    </div>
    <div class="ci-grid" id="ciGrid"></div>
    <div class="live-fields" id="liveFields" style="display:none">
      <div class="ci-grid" id="liveGrid"></div>
    </div>
  </div>
</div>

<!-- CALL SCREEN -->
<div class="panel call-screen" id="callScreen">
  <div class="call-timer" id="callTimer">00:00</div>
  <div class="status-bar idle" id="statusBar">Conectando...</div>
  <div class="state-chips" id="stateChips"></div>

  <!-- Language Selector -->
  <div class="lang-selector" id="langSelector">
    <div class="lang-hint" id="langHint">Esperando saludo del sistema...</div>
    <div class="lang-buttons">
      <button class="btn-lang" id="btnLang1" onclick="selectLanguage('1')" disabled>
        <span class="flag">ğŸ‡ªğŸ‡¸</span> Presione 1<br>EspaÃ±ol
      </button>
      <button class="btn-lang" id="btnLang2" onclick="selectLanguage('2')" disabled>
        <span class="flag">ğŸ‡ºğŸ‡¸</span> Press 2<br>English
      </button>
    </div>
  </div>

  <!-- Active Call Area (mic auto-on, hang up button) -->
  <div class="call-active-area" id="callActiveArea">
    <!-- Mic indicator -->
    <div class="mic-indicator listening" id="micIndicator">
      <div class="sound-wave" id="soundWave">
        <div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div>
      </div>
      <span id="micIndicatorText">ğŸ¤ Escuchando...</span>
    </div>

    <!-- Live interim text -->
    <div class="interim-text" id="interimText"></div>

    <!-- Big hang-up button -->
    <button class="btn-hangup-big" id="btnHangup" onclick="hangUp()">ğŸ“µ</button>
    <div class="hangup-label">Colgar</div>

    <!-- Text fallback (hidden, for when voice fails) -->
    <div class="text-fallback" id="textFallback">
      <button class="text-fallback-toggle" onclick="toggleTextFallback()">âŒ¨ï¸ Usar modo texto</button>
      <div id="textFallbackBody" style="display:none">
        <div class="text-input-row">
          <input type="text" id="txtMsg" placeholder="Escribe tu mensaje..." onkeydown="if(event.key==='Enter')sendTextMsg()" />
          <button class="btn btn-sm btn-primary" onclick="sendTextMsg()">Enviar</button>
        </div>
      </div>
    </div>

    <!-- Mic diagnostics -->
    <div style="text-align:center; margin-top:8px;">
      <button class="mic-test-btn" onclick="testMicrophone()">ğŸ” Diagnosticar micrÃ³fono</button>
    </div>
    <div class="debug-panel" id="debugPanel" style="display:none;"></div>
  </div>

  <!-- Finished overlay -->
  <div class="finished-overlay" id="finishedOverlay">
    <div class="check">âœ…</div>
    <h3 id="finishedTitle">Cita agendada exitosamente</h3>
    <p id="finishedSummary">La conversaciÃ³n ha finalizado.</p>
  </div>

  <!-- Transcript -->
  <div style="margin-top:14px;">
    <h2 style="font-size:.85rem;color:var(--accent);margin-bottom:6px;">ğŸ’¬ TranscripciÃ³n de la llamada</h2>
    <div class="transcript" id="transcript"></div>
  </div>

  <!-- Bottom controls -->
  <div class="controls-row" style="margin-top:12px;">
    <button class="btn btn-sm btn-ghost" onclick="newCall()">ğŸ”„ Nueva llamada</button>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BlindsBook â€” Simulador de Llamada en Tiempo Real
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//
// FLUJO:
// 1. Ingresa telÃ©fono â†’ "Llamar" â†’ busca cliente â†’ conecta con IA
// 2. IA saluda + pide idioma â†’ botones 1 (ES) / 2 (EN)
// 3. Al seleccionar idioma â†’ MIC SE ABRE AUTOMÃTICAMENTE
// 4. Hablas â†’ silencio detectado (1.8s) â†’ envÃ­a al servidor automÃ¡ticamente
// 5. IA responde con audio â†’ mic se pausa â†’ audio se reproduce
// 6. Audio termina â†’ mic se reabre automÃ¡ticamente
// 7. Repite 4-6 hasta terminar la cita
// 8. BotÃ³n grande rojo = COLGAR (termina la llamada y la escucha)
//
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

var API = function() { return document.getElementById('serverUrl').value.replace(/\/$/,''); };

// â”€â”€â”€ State â”€â”€â”€
var callId = null;
var callActive = false;
var callStartTime = null;
var callTimerInterval = null;
var chosenLanguage = null;
var recognition = null;
var micActive = false;        // true = mic listening (part of the call)
var isProcessing = false;     // waiting for server response
var isPlaying = false;        // IA audio playing
var currentAudio = null;
var lastLookupResult = null;
var conversationFinished = false;

// Speech accumulation
var accumulatedFinal = '';    // final recognized segments
var interimBuffer = '';       // current interim text
var silenceTimer = null;      // fires after silence to auto-send
var SILENCE_DELAY = 2200;    // ms of silence before auto-sending (increased for network latency)
var NETWORK_RETRY_DELAY = 500; // ms to wait before retrying after network error
var hasSpeechThisTurn = false;

var speechRetryCount = 0;
var MAX_SPEECH_RETRIES = 3;
var consecutiveErrors = 0;
var MAX_CONSECUTIVE_ERRORS = 5;
var noAudioTimeout = null;
var NO_AUDIO_TIMEOUT_MS = 8000; // 8s without any audio = problem

var SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

// â•â•â• DEBUG LOG â•â•â•
function debugLog(msg, level) {
  level = level || 'ok';
  var panel = document.getElementById('debugPanel');
  if (!panel) return;
  panel.style.display = 'block';
  var line = document.createElement('div');
  line.className = 'dbg-line ' + level;
  var ts = new Date().toLocaleTimeString('es', {hour:'2-digit',minute:'2-digit',second:'2-digit'});
  line.textContent = '[' + ts + '] ' + msg;
  panel.appendChild(line);
  panel.scrollTop = panel.scrollHeight;
  console.log('[MIC-DEBUG]', msg);
}

// â•â•â• MIC TEST â•â•â•
async function testMicrophone() {
  var panel = document.getElementById('debugPanel');
  panel.style.display = 'block';
  panel.innerHTML = '';

  // 1. Check secure context
  if (window.isSecureContext) {
    debugLog('âœ… Contexto seguro (HTTPS o localhost)', 'ok');
  } else {
    debugLog('âŒ NO es contexto seguro â€” el micrÃ³fono NO funcionarÃ¡. Usa http://localhost:4000', 'err');
    return;
  }

  // 2. Check Web Speech API
  if (SpeechRecognition) {
    debugLog('âœ… Web Speech API disponible', 'ok');
  } else {
    debugLog('âŒ Web Speech API NO disponible â€” usa Chrome o Edge (no Firefox)', 'err');
    return;
  }

  // 3. Check navigator.mediaDevices
  if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
    debugLog('âœ… MediaDevices API disponible', 'ok');
  } else {
    debugLog('âŒ MediaDevices API no disponible â€” verifica HTTPS/localhost', 'err');
    return;
  }

  // 4. Request mic permission
  debugLog('ğŸ¤ Solicitando permiso de micrÃ³fono...', 'warn');
  try {
    var stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    var tracks = stream.getAudioTracks();
    debugLog('âœ… MicrÃ³fono permitido: ' + tracks[0].label, 'ok');

    // 5. Check if mic has audio (quick level test)
    debugLog('ğŸ”Š Verificando nivel de audio... habla algo', 'warn');
    var audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    var analyser = audioCtx.createAnalyser();
    var source = audioCtx.createMediaStreamSource(stream);
    source.connect(analyser);
    analyser.fftSize = 256;
    var dataArray = new Uint8Array(analyser.frequencyBinCount);

    var maxLevel = 0;
    var checks = 0;
    var levelTestInterval = setInterval(function() {
      analyser.getByteFrequencyData(dataArray);
      var avg = 0;
      for (var i = 0; i < dataArray.length; i++) avg += dataArray[i];
      avg = avg / dataArray.length;
      if (avg > maxLevel) maxLevel = avg;
      checks++;
      if (checks >= 30) { // ~3 seconds
        clearInterval(levelTestInterval);
        stream.getTracks().forEach(function(t) { t.stop(); });
        audioCtx.close();
        if (maxLevel > 5) {
          debugLog('âœ… Audio detectado â€” nivel mÃ¡x: ' + maxLevel.toFixed(1), 'ok');
        } else {
          debugLog('âš ï¸ Nivel de audio MUY BAJO (' + maxLevel.toFixed(1) + ') â€” Â¿estÃ¡ el micrÃ³fono silenciado?', 'warn');
        }

        // 6. Quick Speech Recognition test
        debugLog('ğŸ—£ï¸ Probando reconocimiento de voz... di algo', 'warn');
        testSpeechRecognition();
      }
    }, 100);

  } catch(err) {
    debugLog('âŒ Permiso de micrÃ³fono DENEGADO: ' + err.message, 'err');
    debugLog('â†’ Haz clic en el Ã­cono de candado ğŸ”’ en la barra de URL â†’ MicrÃ³fono â†’ Permitir', 'warn');
  }
}

function testSpeechRecognition() {
  var testRec = new SpeechRecognition();
  testRec.lang = 'es-ES';
  testRec.interimResults = true;
  testRec.continuous = false;
  testRec.maxAlternatives = 1;

  var gotResult = false;
  var testTimeout = setTimeout(function() {
    if (!gotResult) {
      debugLog('âš ï¸ Sin resultado en 5s â€” puede ser problema de red (Chrome usa servidores de Google)', 'warn');
      debugLog('â†’ Verifica tu conexiÃ³n a internet', 'warn');
      try { testRec.stop(); } catch(e) {}
    }
  }, 5000);

  testRec.onresult = function(event) {
    gotResult = true;
    clearTimeout(testTimeout);
    var text = event.results[0][0].transcript;
    debugLog('âœ… Â¡Voz reconocida! "' + text + '" (confianza: ' + (event.results[0][0].confidence * 100).toFixed(0) + '%)', 'ok');
    debugLog('âœ… TODO FUNCIONA â€” el micrÃ³fono y el reconocimiento estÃ¡n OK', 'ok');
    try { testRec.stop(); } catch(e) {}
  };

  testRec.onerror = function(event) {
    clearTimeout(testTimeout);
    if (event.error === 'no-speech') {
      debugLog('âš ï¸ No se detectÃ³ voz â€” habla mÃ¡s fuerte o acÃ©rcate al micrÃ³fono', 'warn');
    } else if (event.error === 'not-allowed') {
      debugLog('âŒ Permiso de micrÃ³fono denegado para reconocimiento de voz', 'err');
    } else if (event.error === 'network') {
      debugLog('âŒ Error de red â€” Chrome necesita internet para reconocimiento de voz', 'err');
    } else {
      debugLog('âŒ Error de reconocimiento: ' + event.error, 'err');
    }
  };

  testRec.onend = function() {
    clearTimeout(testTimeout);
    if (!gotResult) {
      debugLog('âš ï¸ Reconocimiento terminÃ³ sin resultado. Intenta hablar mÃ¡s claro o fuerte.', 'warn');
    }
  };

  try {
    testRec.start();
    debugLog('ğŸ™ï¸ Reconocimiento iniciado â€” tienes 5 segundos para hablar...', 'ok');
  } catch(e) {
    debugLog('âŒ No se pudo iniciar reconocimiento: ' + e.message, 'err');
  }
}

// â•â•â• SETTINGS â•â•â•
function toggleSettings() {
  document.getElementById('settingsBody').classList.toggle('open');
}

// â•â•â• START CALL â•â•â•
async function startCall() {
  var phone = document.getElementById('customerPhone').value.trim();
  if (!phone || phone.length < 3) {
    setDialerStatus('notfound', 'âš ï¸ Ingresa al menos 3 caracteres del telÃ©fono');
    return;
  }

  var btn = document.getElementById('btnCall');
  btn.disabled = true;
  btn.textContent = 'â³ Buscando...';
  setDialerStatus('searching', 'ğŸ” Buscando "' + phone + '" en el sistema...');

  try {
    var resp = await fetch(API() + '/debug/customer-lookup?phone=' + encodeURIComponent(phone));
    if (!resp.ok) throw new Error('HTTP ' + resp.status);
    var data = await resp.json();

    if (!data.results || data.results.length === 0) {
      setDialerStatus('notfound', 'âŒ No encontrado. CompaÃ±Ã­as: ' + data.companiesSearched.join(', '));
      btn.disabled = false;
      btn.textContent = 'ğŸ“ Llamar';
      return;
    }

    var customer = data.results[0];
    lastLookupResult = customer;
    document.getElementById('companySelect').value = customer.twilioNumber;
    document.getElementById('callerPhone').value = customer.phone || phone;
    showCustomerInfo(customer);
    setDialerStatus('found', 'âœ… ' + (customer.firstName || '') + ' ' + (customer.lastName || '') + ' â€” CompaÃ±Ã­a ' + customer.companyId);

    btn.textContent = 'ğŸ“ Conectando...';
    setDialerStatus('connecting', 'ğŸ“¡ Conectando con la recepcionista IA...');
    await startCallSession();
  } catch(err) {
    setDialerStatus('notfound', 'âŒ Error: ' + err.message);
    btn.disabled = false;
    btn.textContent = 'ğŸ“ Llamar';
  }
}

function showCustomerInfo(customer) {
  var name = [customer.firstName, customer.lastName].filter(Boolean).join(' ') || 'â€”';
  document.getElementById('ciName').textContent = 'ğŸ‘¤ ' + name;
  document.getElementById('ciBadge').textContent = (customer.companyName || 'CompaÃ±Ã­a') + ' (ID: ' + customer.companyId + ')';
  var grid = document.getElementById('ciGrid');
  grid.innerHTML = '';
  var fields = [
    { label:'ID', value:customer.id, hl:true },
    { label:'TelÃ©fono', value:customer.phone||'â€”', hl:true },
    { label:'Account Mgr', value:customer.accountManagerId||'N/A' },
  ];
  for (var i = 0; i < fields.length; i++) {
    var f = fields[i];
    grid.innerHTML += '<div class="cf"><div class="lbl">'+f.label+'</div><div class="val'+(f.hl?' hl':'')+'">'+f.value+'</div></div>';
  }
  document.getElementById('customerInfo').className = 'customer-info visible';
}

function setDialerStatus(cls, text) {
  var el = document.getElementById('dialerStatus');
  el.className = cls;
  el.textContent = text;
}

// â•â•â• MIC PRE-CHECK â•â•â•
async function checkMicrophoneAccess() {
  debugLog('ğŸ” Verificando acceso al micrÃ³fono antes de iniciar...', 'warn');
  document.getElementById('debugPanel').style.display = 'block';

  // Check secure context
  if (!window.isSecureContext) {
    debugLog('âŒ NO es contexto seguro â€” usa http://localhost:4000', 'err');
    return false;
  }

  // Enumerate devices to see if there's a mic at all
  try {
    var devices = await navigator.mediaDevices.enumerateDevices();
    var mics = devices.filter(function(d) { return d.kind === 'audioinput'; });
    if (mics.length === 0) {
      debugLog('âŒ Windows no reporta NINGÃšN micrÃ³fono conectado al PC', 'err');
      debugLog('â†’ Conecta un micrÃ³fono o auriculares con mic y recarga la pÃ¡gina', 'warn');
      return false;
    }
    debugLog('ğŸ¤ MicrÃ³fonos detectados (' + mics.length + '):', 'ok');
    mics.forEach(function(m, i) {
      debugLog('   ' + (i+1) + '. ' + (m.label || '(sin nombre â€” Â¿permiso pendiente?)'), 'ok');
    });
  } catch(e) {
    debugLog('âš ï¸ No se pudo enumerar dispositivos: ' + e.message, 'warn');
  }

  // Try to actually open the mic
  try {
    var stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    var trackLabel = stream.getAudioTracks()[0].label;
    debugLog('âœ… MicrÃ³fono accesible: ' + trackLabel, 'ok');
    // Release the mic immediately so Speech Recognition can use it
    stream.getTracks().forEach(function(t) { t.stop(); });
    return true;
  } catch(err) {
    debugLog('âŒ No se puede acceder al micrÃ³fono: ' + err.name + ' â€” ' + err.message, 'err');
    if (err.name === 'NotAllowedError') {
      debugLog('â†’ Permiso denegado. Clic en ğŸ”’ barra de URL â†’ MicrÃ³fono â†’ Permitir â†’ Recargar', 'warn');
    } else if (err.name === 'NotFoundError') {
      debugLog('â†’ No se encontrÃ³ micrÃ³fono. Â¿EstÃ¡ conectado? Â¿Lo usa otra app (Discord, Zoom, Teams)?', 'warn');
    } else if (err.name === 'NotReadableError' || err.name === 'AbortError') {
      debugLog('â†’ El micrÃ³fono estÃ¡ ocupado por otra aplicaciÃ³n.', 'err');
      debugLog('â†’ CIERRA Discord, Zoom, Teams, OBS u otra app que use el mic, luego recarga.', 'warn');
    } else {
      debugLog('â†’ Error inesperado. Verifica el micrÃ³fono en ConfiguraciÃ³n de Windows â†’ Sonido â†’ Entrada', 'warn');
    }
    return false;
  }
}

// â•â•â• CALL SESSION â•â•â•
async function startCallSession() {
  callId = 'call-' + Date.now();
  callActive = true;
  conversationFinished = false;
  chosenLanguage = null;
  accumulatedFinal = '';
  interimBuffer = '';
  consecutiveErrors = 0;

  document.getElementById('callScreen').className = 'panel call-screen active';
  document.getElementById('btnCall').style.display = 'none';
  document.getElementById('transcript').innerHTML = '';
  document.getElementById('langSelector').style.display = 'block';
  document.getElementById('callActiveArea').className = 'call-active-area';
  document.getElementById('finishedOverlay').className = 'finished-overlay';
  document.getElementById('langHint').textContent = 'Conectando...';
  document.getElementById('btnLang1').disabled = true;
  document.getElementById('btnLang2').disabled = true;
  document.getElementById('liveFields').style.display = 'none';
  document.getElementById('textFallbackBody').style.display = 'none';

  callStartTime = Date.now();
  clearInterval(callTimerInterval);
  callTimerInterval = setInterval(updateCallTimer, 1000);
  document.getElementById('callTimer').className = 'call-timer active';

  setStatusBar('ringing', 'ğŸ“¡ Verificando micrÃ³fono...');
  addMessage('system', 'ğŸ“ Iniciando llamada...');

  // Pre-check microphone before starting the call
  var micOk = await checkMicrophoneAccess();
  if (!micOk) {
    setStatusBar('error', 'âš ï¸ MicrÃ³fono no disponible â€” usa âŒ¨ï¸ modo texto');
    addMessage('system', 'âš ï¸ No se pudo acceder al micrÃ³fono. Puedes usar el modo texto (âŒ¨ï¸) para continuar la conversaciÃ³n.');
    document.getElementById('textFallbackBody').style.display = 'block';
    // Still continue the call â€” just without mic. User can type.
  } else {
    debugLog('âœ… MicrÃ³fono listo â€” iniciando llamada', 'ok');
  }

  setStatusBar('ringing', 'ğŸ“¡ Conectando con BlindsBook IA...');
  await sleep(500);

  try {
    var result = await sendToServer(null);
    if (result) {
      document.getElementById('langHint').textContent = '';
      document.getElementById('btnLang1').disabled = false;
      document.getElementById('btnLang2').disabled = false;
      setStatusBar('idle', 'Selecciona el idioma presionando 1 o 2');
    }
  } catch(err) {
    setStatusBar('error', 'âŒ Error: ' + err.message);
  }
}

// â•â•â• LANGUAGE SELECTION â•â•â•
async function selectLanguage(choice) {
  document.getElementById('btnLang1').disabled = true;
  document.getElementById('btnLang2').disabled = true;
  setStatusBar('processing', 'â³ Enviando selecciÃ³n...');

  chosenLanguage = choice === '1' ? 'es' : 'en';
  addMessage('user', choice === '1' ? 'EspaÃ±ol (1)' : 'English (2)');
  debugLog('ğŸŒ Idioma seleccionado: ' + chosenLanguage, 'ok');

  var result = await sendToServer(choice);

  // Hide language, show active call area
  document.getElementById('langSelector').style.display = 'none';
  document.getElementById('callActiveArea').className = 'call-active-area visible';
  document.getElementById('textFallback').className = 'text-fallback visible';
  debugLog('ğŸ“ Ãrea de llamada activa â€” mic deberÃ­a abrirse', 'ok');
}

// â•â•â• REAL-TIME MICROPHONE (auto-listen, auto-send on silence) â•â•â•
var isStartingRecognition = false; // Prevent multiple simultaneous starts

function startListening() {
  if (!SpeechRecognition) { debugLog('âŒ SpeechRecognition no disponible', 'err'); return; }
  if (!callActive) { debugLog('âš ï¸ startListening: llamada no activa', 'warn'); return; }
  if (conversationFinished) { debugLog('âš ï¸ startListening: conversaciÃ³n terminada', 'warn'); return; }
  if (isProcessing) { debugLog('âš ï¸ startListening: aÃºn procesando respuesta', 'warn'); return; }
  if (isPlaying) { debugLog('âš ï¸ startListening: audio aÃºn reproduciÃ©ndose', 'warn'); return; }
  if (isStartingRecognition) { debugLog('âš ï¸ startListening: ya iniciando...', 'warn'); return; }

  isStartingRecognition = true;
  micActive = true;
  accumulatedFinal = '';
  interimBuffer = '';
  hasSpeechThisTurn = false;
  clearTimeout(silenceTimer);
  setMicIndicator('listening');
  document.getElementById('interimText').textContent = '';
  
  var langCode = chosenLanguage === 'en' ? 'en-US' : 'es-ES';

  // Clean up previous recognition instance and wait before creating new one
  if (recognition) {
    try { 
      recognition.onend = null; // Remove handler to prevent restart loop
      recognition.onerror = null;
      recognition.abort(); 
    } catch(e) {}
    recognition = null;
  }

  // Small delay to ensure previous recognition is fully stopped
  setTimeout(function() {
    if (!callActive || conversationFinished || isProcessing || isPlaying) {
      isStartingRecognition = false;
      return;
    }
    
    debugLog('ğŸ¤ Iniciando reconocimiento â€” lang=' + langCode, 'ok');
    
    recognition = new SpeechRecognition();
    recognition.lang = langCode;
    recognition.interimResults = true;
    recognition.continuous = true;
    recognition.maxAlternatives = 1;

  recognition.onresult = function(event) {
    if (!micActive) return;
    consecutiveErrors = 0; // Mic is working â€” reset error counter
    clearTimeout(noAudioTimeout); // Cancel the "no audio" warning

    var finalText = '';
    var interimText = '';
    for (var i = 0; i < event.results.length; i++) {
      if (event.results[i].isFinal) {
        finalText += event.results[i][0].transcript + ' ';
      } else {
        interimText += event.results[i][0].transcript;
      }
    }

    accumulatedFinal = finalText.trim();
    interimBuffer = interimText.trim();
    var display = (accumulatedFinal + ' ' + interimBuffer).trim();

    if (display) {
      hasSpeechThisTurn = true;
      document.getElementById('interimText').textContent = 'ğŸ’¬ "' + display + '"';
      setMicIndicator('listening');
      debugLog('ğŸ’¬ Voz: "' + display + '"', 'ok');

      // Reset silence timer â€” will fire after SILENCE_DELAY ms of no new results
      clearTimeout(silenceTimer);
      silenceTimer = setTimeout(function() {
        onSilenceDetected();
      }, SILENCE_DELAY);
    }
  };

  recognition.onerror = function(event) {
    console.warn('Speech error:', event.error);
    debugLog('âš ï¸ Speech error: ' + event.error, event.error === 'no-speech' ? 'warn' : 'err');
    if (event.error === 'no-speech') {
      // Just keep listening silently
      if (micActive) {
        setMicIndicator('listening');
      }
    } else if (event.error === 'not-allowed') {
      micActive = false;
      setMicIndicator('paused');
      setStatusBar('error', 'âš ï¸ Permiso de micrÃ³fono denegado. Permite el acceso y recarga.');
      addMessage('system', 'âš ï¸ MicrÃ³fono bloqueado. Haz clic en ğŸ”’ en la barra de URL â†’ MicrÃ³fono â†’ Permitir, luego recarga.');
    } else if (event.error === 'network') {
      debugLog('âš ï¸ Error de red â€” reintentando...', 'warn');
      // Network errors are common with Web Speech API - retry silently
      if (speechRetryCount < MAX_SPEECH_RETRIES && micActive && callActive) {
        speechRetryCount++;
        debugLog('ğŸ”„ Reintento automÃ¡tico (' + speechRetryCount + '/' + MAX_SPEECH_RETRIES + ')', 'warn');
        setTimeout(function() { 
          if (micActive && callActive && !isProcessing && !isPlaying) {
            startListening(); 
          }
        }, NETWORK_RETRY_DELAY);
        return;
      }
      // After max retries, keep trying but show message
      debugLog('âš ï¸ ConexiÃ³n inestable â€” continuando con reintentos', 'warn');
      speechRetryCount = 0; // Reset for next batch of retries
      setTimeout(function() { 
        if (micActive && callActive && !isProcessing && !isPlaying) {
          startListening(); 
        }
      }, 1000);
    } else if (event.error === 'audio-capture') {
      consecutiveErrors++;
      debugLog('âŒ audio-capture error #' + consecutiveErrors + ' â€” no se puede acceder al micrÃ³fono', 'err');
      if (consecutiveErrors >= MAX_CONSECUTIVE_ERRORS) {
        micActive = false;
        setMicIndicator('paused');
        setStatusBar('error', 'âš ï¸ No se detecta micrÃ³fono. Verifica que estÃ¡ conectado y no lo usa otra app.');
        addMessage('system', 'ğŸ¤ Error de captura de audio. Posibles causas:\nâ€¢ No hay micrÃ³fono conectado al PC\nâ€¢ Otra app (Zoom, Teams, Discord) estÃ¡ usando el mic\nâ€¢ El micrÃ³fono estÃ¡ deshabilitado en Windows (Panel de Control â†’ Sonido â†’ Grabar)\nâ€¢ Chrome no tiene acceso al micrÃ³fono en Windows (ConfiguraciÃ³n â†’ Privacidad â†’ MicrÃ³fono)\n\nSoluciÃ³n: cierra otras apps que usen el mic, verifica en ConfiguraciÃ³n de Windows, y recarga la pÃ¡gina.\n\nMientras tanto, usa âŒ¨ï¸ modo texto abajo.');
        document.getElementById('textFallbackBody').style.display = 'block';
        return;
      }
    } else if (event.error === 'aborted') {
      // Aborted is normal when stopping/restarting - don't log or count as error
      isStartingRecognition = false;
    }
  };

  recognition.onend = function() {
    isStartingRecognition = false;
    
    // Prevent infinite restart if errors keep happening
    if (consecutiveErrors >= MAX_CONSECUTIVE_ERRORS) {
      debugLog('ğŸ›‘ Demasiados errores â€” usa modo texto', 'err');
      micActive = false;
      setMicIndicator('paused');
      document.getElementById('textFallbackBody').style.display = 'block';
      return;
    }
    
    // Only restart if call is still active and we should be listening
    if (micActive && callActive && !conversationFinished && !isProcessing && !isPlaying) {
      // Longer delay to prevent rapid restart loop
      var delay = Math.max(500, 300 * (consecutiveErrors + 1));
      debugLog('ğŸ”„ Reiniciando en ' + delay + 'ms...', 'warn');
      setTimeout(function() {
        if (micActive && callActive && !isProcessing && !isPlaying && !isStartingRecognition) {
          startListening();
        }
      }, delay);
    }
  };
  
  // Only log important events to reduce noise
  recognition.onspeechstart = function() {
    debugLog('ğŸ—£ï¸ Â¡VOZ detectada!', 'ok');
    consecutiveErrors = 0; // Voice detected = working
  };

    try {
      recognition.start();
      speechRetryCount = 0;
      isStartingRecognition = false;
      debugLog('âœ… Escuchando...', 'ok');
      
      // Start a "no audio" timeout to detect if mic isn't working
      clearTimeout(noAudioTimeout);
      noAudioTimeout = setTimeout(function() {
        if (micActive && !hasSpeechThisTurn && callActive && !isProcessing && !isPlaying) {
          debugLog('âš ï¸ Sin voz detectada â€” usa modo texto si hay problemas', 'warn');
          document.getElementById('textFallbackBody').style.display = 'block';
        }
      }, NO_AUDIO_TIMEOUT_MS);
      
    } catch(e) {
      isStartingRecognition = false;
      if (e.message && e.message.indexOf('already started') === -1) {
        console.warn('Mic start error:', e);
        debugLog('âŒ Error: ' + e.message, 'err');
        consecutiveErrors++;
      }
    }
  }, 100); // 100ms delay before starting new recognition
}

function stopListening() {
  micActive = false;
  clearTimeout(silenceTimer);
  clearTimeout(noAudioTimeout);
  if (recognition) {
    try { recognition.stop(); } catch(e) {}
    recognition = null;
  }
  document.getElementById('interimText').textContent = '';
}

function onSilenceDetected() {
  if (!micActive || isProcessing || isPlaying) return;

  var text = (accumulatedFinal + ' ' + interimBuffer).trim();
  if (!text) return;

  // Stop listening, send, then resume after response
  stopListening();
  setMicIndicator('processing');
  document.getElementById('interimText').textContent = '';

  addMessage('user', text);
  sendToServer(text);
}

function setMicIndicator(state) {
  var el = document.getElementById('micIndicator');
  var textEl = document.getElementById('micIndicatorText');
  var waveEl = document.getElementById('soundWave');
  var es = chosenLanguage === 'es';

  el.className = 'mic-indicator ' + state;

  if (state === 'listening') {
    waveEl.style.display = 'inline-flex';
    textEl.textContent = es ? 'ğŸ¤ Escuchando...' : 'ğŸ¤ Listening...';
    setStatusBar('listening', es ? 'ğŸ¤ En llamada â€” habla naturalmente' : 'ğŸ¤ On call â€” speak naturally');
  } else if (state === 'speaking') {
    waveEl.style.display = 'inline-flex';
    textEl.textContent = es ? 'ğŸ”Š Recepcionista hablando...' : 'ğŸ”Š Receptionist speaking...';
    setStatusBar('speaking', es ? 'ğŸ”Š Recepcionista hablando...' : 'ğŸ”Š Receptionist speaking...');
  } else if (state === 'processing') {
    waveEl.style.display = 'none';
    textEl.textContent = es ? 'â³ Procesando...' : 'â³ Processing...';
    setStatusBar('processing', es ? 'â³ Procesando tu mensaje...' : 'â³ Processing your message...');
  } else if (state === 'paused') {
    waveEl.style.display = 'none';
    textEl.textContent = es ? 'â¸ MicrÃ³fono pausado' : 'â¸ Mic paused';
  }
}

// â•â•â• TEXT FALLBACK â•â•â•
function toggleTextFallback() {
  var body = document.getElementById('textFallbackBody');
  body.style.display = body.style.display === 'none' ? 'block' : 'none';
  if (body.style.display === 'block') {
    document.getElementById('txtMsg').focus();
  }
}

function sendTextMsg() {
  var input = document.getElementById('txtMsg');
  var text = input.value.trim();
  if (!text || conversationFinished || isProcessing) return;
  input.value = '';

  // Pause mic while sending
  stopListening();
  addMessage('user', text);
  sendToServer(text);
}

// â•â•â• SERVER COMMUNICATION â•â•â•
async function sendToServer(text) {
  isProcessing = true;
  if (text !== null) setMicIndicator('processing');

  var body = {
    callId: callId,
    text: text,
    toNumber: document.getElementById('companySelect').value || null,
    fromNumber: document.getElementById('callerPhone').value || null,
  };

  try {
    var resp = await fetch(API() + '/debug/voice-chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body),
    });

    if (!resp.ok) throw new Error('HTTP ' + resp.status);
    var data = await resp.json();

    var stepLabel = data.state ? data.state.step : '?';
    addMessage('ia', data.replyText, 'Step: ' + stepLabel + ' | TTS: ' + data.ttsProvider);
    updateStateChips(data.state);
    updateLiveFields(data.state);

    // Play audio
    if (data.audioBase64) {
      isPlaying = true;
      setMicIndicator('speaking');
      debugLog('ğŸ”Š Reproduciendo audio TTS (' + Math.round(data.audioBase64.length/1024) + ' KB)...', 'ok');
      await playAudioBase64(data.audioBase64);
      isPlaying = false;
      debugLog('ğŸ”Š Audio terminado â€” isPlaying=false', 'ok');
    }

    isProcessing = false;

    // Check finished
    if (data.isFinished) {
      conversationFinished = true;
      stopListening();
      var summary = buildFinishedSummary(data.state);
      document.getElementById('finishedSummary').innerHTML = summary;
      document.getElementById('finishedOverlay').className = 'finished-overlay visible';
      document.getElementById('callActiveArea').className = 'call-active-area';
      setStatusBar('idle', 'âœ… Cita agendada â€” llamada finalizada');
      addMessage('system', 'âœ… Cita agendada exitosamente.');
      stopCallTimer();
      return data;
    }

    // Auto-resume listening after IA speaks (if call active and language chosen)
    if (callActive && chosenLanguage && !conversationFinished) {
      debugLog('â†’ Llamando startListening() â€” callActive=' + callActive + ' lang=' + chosenLanguage, 'ok');
      startListening();
    } else {
      debugLog('âš ï¸ NO se llama startListening â€” callActive=' + callActive + ' lang=' + chosenLanguage + ' finished=' + conversationFinished, 'warn');
    }

    return data;
  } catch(err) {
    isProcessing = false;
    setStatusBar('error', 'âŒ Error: ' + err.message);
    addMessage('system', 'âš ï¸ Error: ' + err.message);
    // Try to resume listening after error
    if (callActive && chosenLanguage && !conversationFinished) {
      setTimeout(function() { startListening(); }, 2000);
    }
    return null;
  }
}

function buildFinishedSummary(state) {
  if (!state) return '';
  var parts = [];
  if (state.customerConfirmedName) parts.push('<b>Cliente:</b> ' + state.customerConfirmedName);
  if (state.customerId) parts.push('<b>ID:</b> ' + state.customerId);
  if (state.type !== null && state.type !== undefined) {
    var types = ['CotizaciÃ³n/Quote', 'InstalaciÃ³n/Installation', 'ReparaciÃ³n/Repair'];
    parts.push('<b>Tipo:</b> ' + (types[state.type] || state.type));
  }
  if (state.startDateISO) parts.push('<b>Fecha:</b> ' + new Date(state.startDateISO).toLocaleString());
  if (state.duration) parts.push('<b>DuraciÃ³n:</b> ' + state.duration);
  return parts.join('<br>');
}

// â•â•â• AUDIO â•â•â•
function playAudioBase64(b64) {
  return new Promise(function(resolve) {
    if (currentAudio) { currentAudio.pause(); currentAudio = null; }
    var audio = new Audio('data:audio/mpeg;base64,' + b64);
    currentAudio = audio;
    audio.onended = function() { currentAudio = null; resolve(); };
    audio.onerror = function() { currentAudio = null; resolve(); };
    audio.play().catch(function(err) {
      console.warn('Autoplay blocked:', err);
      addMessage('system', 'âš ï¸ Click en la pÃ¡gina para permitir audio y vuelve a hablar.');
      currentAudio = null;
      resolve();
    });
  });
}

// â•â•â• STATE DISPLAY â•â•â•
function updateStateChips(state) {
  var bar = document.getElementById('stateChips');
  if (!state) { bar.innerHTML = ''; return; }
  var chips = [
    '<span class="chip"><b>Step:</b> ' + state.step + '</span>',
    '<span class="chip"><b>Lang:</b> ' + (state.language || '?') + '</span>',
  ];
  if (state.callerPhone) chips.push('<span class="chip"><b>From:</b> ' + state.callerPhone + '</span>');
  if (state.type !== null && state.type !== undefined) chips.push('<span class="chip"><b>Tipo:</b> ' + ['CotizaciÃ³n','InstalaciÃ³n','ReparaciÃ³n'][state.type] + '</span>');
  if (state.customerId) chips.push('<span class="chip"><b>ID:</b> ' + state.customerId + '</span>');
  if (state.customerConfirmedName) chips.push('<span class="chip"><b>Cliente:</b> ' + state.customerConfirmedName + '</span>');
  if (state.startDateISO) chips.push('<span class="chip"><b>Fecha:</b> ' + new Date(state.startDateISO).toLocaleString() + '</span>');
  if (state.duration) chips.push('<span class="chip"><b>Dur:</b> ' + state.duration + '</span>');
  bar.innerHTML = chips.join('');
}

function updateLiveFields(state) {
  if (!state || !lastLookupResult) return;
  var container = document.getElementById('liveFields');
  var grid = document.getElementById('liveGrid');
  var fields = [];
  if (state.customerId) fields.push({ label:'âœ“ IDENTIFICADO', value:'ID '+state.customerId });
  if (state.customerConfirmedName) fields.push({ label:'âœ“ NOMBRE', value:state.customerConfirmedName });
  if (state.type !== null && state.type !== undefined) fields.push({ label:'TIPO CITA', value:['CotizaciÃ³n','InstalaciÃ³n','ReparaciÃ³n'][state.type] });
  if (state.startDateISO) fields.push({ label:'FECHA', value:new Date(state.startDateISO).toLocaleString() });
  if (state.duration) fields.push({ label:'DURACIÃ“N', value:state.duration });
  if (fields.length === 0) { container.style.display = 'none'; return; }
  container.style.display = 'block';
  var html = '';
  for (var i = 0; i < fields.length; i++) {
    html += '<div class="cf"><div class="lbl">'+fields[i].label+'</div><div class="val hl">'+fields[i].value+'</div></div>';
  }
  grid.innerHTML = html;
}

// â•â•â• TIMER â•â•â•
function updateCallTimer() {
  if (!callStartTime) return;
  var s = Math.floor((Date.now() - callStartTime) / 1000);
  document.getElementById('callTimer').textContent =
    String(Math.floor(s/60)).padStart(2,'0') + ':' + String(s%60).padStart(2,'0');
}

function stopCallTimer() {
  clearInterval(callTimerInterval);
  document.getElementById('callTimer').className = 'call-timer';
}

// â•â•â• HANG UP â•â•â•
function hangUp() {
  callActive = false;
  conversationFinished = true;
  stopListening();
  stopCallTimer();
  if (currentAudio) { currentAudio.pause(); currentAudio = null; }
  isPlaying = false;
  isProcessing = false;

  setMicIndicator('paused');
  setStatusBar('idle', 'ğŸ“µ Llamada finalizada');
  addMessage('system', 'ğŸ“µ Llamada terminada.');
  document.getElementById('callActiveArea').className = 'call-active-area';
  document.getElementById('langSelector').style.display = 'none';
}

function newCall() {
  callActive = false;
  conversationFinished = false;
  callId = null;
  chosenLanguage = null;
  lastLookupResult = null;
  stopListening();
  stopCallTimer();
  if (currentAudio) { currentAudio.pause(); currentAudio = null; }
  isPlaying = false;
  isProcessing = false;

  document.getElementById('callScreen').className = 'panel call-screen';
  document.getElementById('btnCall').style.display = '';
  document.getElementById('btnCall').disabled = false;
  document.getElementById('btnCall').textContent = 'ğŸ“ Llamar';
  document.getElementById('customerInfo').className = 'customer-info';
  document.getElementById('dialerStatus').textContent = '';
  document.getElementById('callTimer').textContent = '00:00';
  document.getElementById('customerPhone').value = '';
  document.getElementById('customerPhone').focus();
}

// â•â•â• UI â•â•â•
function addMessage(role, text, meta) {
  var div = document.createElement('div');
  div.className = 'msg ' + role;
  if (role === 'user') {
    div.innerHTML = '<div class="speaker">ğŸ§‘ Cliente</div>' + escHtml(text);
  } else if (role === 'ia') {
    div.innerHTML = '<div class="speaker">ğŸ¤– Recepcionista</div>' + escHtml(text);
  } else {
    div.innerHTML = escHtml(text);
  }
  if (meta) {
    var m = document.createElement('div');
    m.className = 'meta';
    m.textContent = meta;
    div.appendChild(m);
  }
  var c = document.getElementById('transcript');
  c.appendChild(div);
  c.scrollTop = c.scrollHeight;
}

function escHtml(s) {
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>');
}

function setStatusBar(cls, text) {
  var el = document.getElementById('statusBar');
  el.className = 'status-bar ' + cls;
  el.textContent = text;
}

function sleep(ms) { return new Promise(function(r) { setTimeout(r, ms); }); }

// â•â•â• INIT â•â•â•
window.addEventListener('load', function() {
  document.getElementById('customerPhone').focus();
  if (!SpeechRecognition) {
    console.warn('Web Speech API not supported â€” voice mode unavailable');
    addMessage('system', 'âš ï¸ Tu navegador NO soporta reconocimiento de voz. Usa Chrome o Edge.');
  }
  // Show initial mic capability
  if (!window.isSecureContext) {
    addMessage('system', 'âš ï¸ PÃ¡gina sin contexto seguro â€” el micrÃ³fono no funcionarÃ¡. Usa http://localhost:4000');
  }
  // Unlock audio on first click
  document.addEventListener('click', function() {
    try {
      var ctx = new (window.AudioContext || window.webkitAudioContext)();
      ctx.resume().then(function() { ctx.close(); });
    } catch(e) {}
  }, { once: true });
});
</script>
</body>
</html>
