<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BlindsBook ‚Äî Prueba de Voz IA Recepcionista</title>
<style>
  :root { --bg:#0f172a; --card:#1e293b; --accent:#3b82f6; --green:#22c55e; --red:#ef4444; --yellow:#eab308; --text:#e2e8f0; --mute:#94a3b8; --border:#475569; }
  * { box-sizing:border-box; margin:0; padding:0; }
  body { font-family:'Segoe UI',system-ui,-apple-system,sans-serif; background:var(--bg); color:var(--text); min-height:100vh; display:flex; flex-direction:column; align-items:center; padding:20px; }
  h1 { font-size:1.5rem; margin-bottom:4px; }
  .subtitle { color:var(--mute); font-size:.85rem; margin-bottom:20px; }
  .panel { background:var(--card); border-radius:12px; padding:20px; width:100%; max-width:840px; margin-bottom:16px; }
  .panel h2 { font-size:1rem; margin-bottom:12px; color:var(--accent); }
  .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:10px; }
  label { font-size:.85rem; color:var(--mute); min-width:90px; }
  select, input[type=text] { background:#334155; border:1px solid var(--border); color:var(--text); padding:8px 12px; border-radius:8px; font-size:.9rem; }
  select { min-width:200px; }
  input[type=text] { flex:1; min-width:200px; }
  .btn { border:none; padding:10px 24px; border-radius:8px; font-size:.95rem; font-weight:600; cursor:pointer; transition:all .2s; display:inline-flex; align-items:center; gap:8px; }
  .btn-primary { background:var(--accent); color:#fff; }
  .btn-primary:hover { background:#2563eb; }
  .btn-search { background:var(--green); color:#fff; padding:8px 18px; font-size:.9rem; }
  .btn-search:hover { background:#16a34a; }
  .btn-search:disabled { opacity:.5; cursor:not-allowed; }
  .btn-record { background:var(--green); color:#fff; font-size:1.1rem; padding:14px 32px; }
  .btn-record.recording { background:var(--red); animation:pulse 1s infinite; }
  .btn-stop { background:var(--red); color:#fff; }
  .btn-sm { padding:6px 14px; font-size:.8rem; }
  .btn:disabled { opacity:.4; cursor:not-allowed; }
  @keyframes pulse { 0%,100%{transform:scale(1)} 50%{transform:scale(1.05)} }
  .controls { display:flex; gap:12px; justify-content:center; margin:16px 0; }
  .transcript { max-height:420px; overflow-y:auto; padding:8px 0; }
  .msg { margin-bottom:12px; padding:10px 14px; border-radius:10px; max-width:90%; line-height:1.5; font-size:.9rem; }
  .msg.user { background:#334155; margin-left:auto; text-align:right; border-bottom-right-radius:2px; }
  .msg.ia { background:#1a3a5c; border-bottom-left-radius:2px; }
  .msg .meta { font-size:.7rem; color:var(--mute); margin-top:4px; }
  .status { text-align:center; padding:8px; font-size:.85rem; border-radius:8px; }
  .status.listening { background:#14532d; color:#4ade80; }
  .status.speaking { background:#1e3a5f; color:#60a5fa; }
  .status.idle { background:#334155; color:var(--mute); }
  .status.error { background:#450a0a; color:#fca5a5; }
  .state-bar { display:flex; gap:8px; flex-wrap:wrap; font-size:.75rem; margin-top:8px; }
  .state-bar .chip { background:#334155; padding:3px 8px; border-radius:4px; }
  .state-bar .chip b { color:var(--accent); }
  .mode-toggle { display:flex; gap:0; border-radius:8px; overflow:hidden; border:1px solid var(--border); }
  .mode-toggle button { background:#334155; color:var(--mute); border:none; padding:8px 16px; cursor:pointer; font-size:.85rem; }
  .mode-toggle button.active { background:var(--accent); color:#fff; }
  #textInput { display:none; }
  #textInput.active { display:flex; }
  .info { background:#1e293b; border:1px solid #334155; border-radius:8px; padding:12px; font-size:.8rem; color:var(--mute); line-height:1.6; }
  .info b { color:var(--text); }

  /* ‚îÄ‚îÄ‚îÄ Customer Lookup Panel ‚îÄ‚îÄ‚îÄ */
  .lookup-input-row { display:flex; gap:8px; align-items:center; }
  .lookup-input-row input { flex:1; font-size:1rem; padding:10px 14px; }
  #lookupStatus { font-size:.8rem; color:var(--mute); margin-top:6px; min-height:20px; }
  #lookupStatus.searching { color:var(--yellow); }
  #lookupStatus.found { color:var(--green); }
  #lookupStatus.notfound { color:var(--red); }

  .customer-card { display:none; margin-top:14px; background:#0f172a; border:1px solid var(--border); border-radius:10px; padding:14px 18px; }
  .customer-card.visible { display:block; }
  .customer-card .card-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
  .customer-card .card-header h3 { font-size:1.05rem; color:var(--green); margin:0; }
  .customer-card .card-header .badge { background:var(--accent); color:#fff; padding:2px 10px; border-radius:12px; font-size:.75rem; font-weight:600; }
  .customer-grid { display:grid; grid-template-columns:1fr 1fr; gap:6px 20px; }
  .customer-grid .field { display:flex; flex-direction:column; padding:4px 0; }
  .customer-grid .field .lbl { font-size:.7rem; color:var(--mute); text-transform:uppercase; letter-spacing:.5px; }
  .customer-grid .field .val { font-size:.88rem; color:var(--text); font-weight:500; }
  .customer-grid .field .val.highlight { color:var(--accent); }
  .customer-grid .field .val.dim { color:var(--mute); font-style:italic; }
  .config-auto { margin-top:10px; padding:8px 12px; background:#1a2744; border:1px solid #2d4a7a; border-radius:8px; font-size:.8rem; color:#93c5fd; }
  .config-auto b { color:var(--accent); }

  @keyframes fadeIn { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:none} }
  .customer-card.visible { animation: fadeIn .3s ease; }

  /* ‚îÄ‚îÄ‚îÄ Language Selection Panel ‚îÄ‚îÄ‚îÄ */
  .lang-panel { text-align:center; }
  .lang-panel p { color:var(--mute); font-size:.9rem; margin-bottom:12px; }
  .lang-buttons { display:flex; gap:12px; justify-content:center; }
  .btn-lang { padding:14px 32px; font-size:1rem; font-weight:700; border-radius:10px; border:2px solid var(--border); background:#334155; color:var(--text); cursor:pointer; transition:all .2s; min-width:200px; }
  .btn-lang:hover { border-color:var(--accent); background:#1e3a5f; }
  .btn-lang:disabled { opacity:.4; cursor:not-allowed; }
  .btn-lang .flag { font-size:1.4rem; display:block; margin-bottom:4px; }
  #langPanel.done { display:none; }
</style>
</head>
<body>

<h1>üéôÔ∏è BlindsBook ‚Äî IA Recepcionista</h1>
<p class="subtitle">Prueba de voz en tiempo real ‚Äî Busca un cliente por tel√©fono, luego habla o escribe</p>

<!-- CUSTOMER LOOKUP -->
<div class="panel">
  <h2>üîç B√∫squeda de Cliente por Tel√©fono</h2>
  <div class="lookup-input-row">
    <input type="text" id="customerPhone" placeholder="Ingresa el n√∫mero de tel√©fono del cliente (ej: 305-123-4567)" 
           onkeydown="if(event.key==='Enter')lookupCustomer()" />
    <button class="btn btn-search" id="btnSearch" onclick="lookupCustomer()">üîç Buscar</button>
  </div>
  <div id="lookupStatus"></div>

  <div class="customer-card" id="customerCard">
    <div class="card-header">
      <h3 id="cardCustomerName">‚Äî</h3>
      <span class="badge" id="cardCompanyBadge">‚Äî</span>
    </div>
    <div class="customer-grid" id="customerGrid">
      <!-- Populated dynamically -->
    </div>
    <div class="config-auto" id="configAutoMsg" style="display:none">
      ‚úÖ Configuraci√≥n aplicada autom√°ticamente ‚Äî <b>toNumber</b>: <span id="autoToNumber"></span> | <b>fromNumber (Caller ID)</b>: <span id="autoFromNumber"></span>
    </div>
  </div>
</div>

<!-- CONFIG -->
<div class="panel">
  <h2>‚öôÔ∏è Configuraci√≥n</h2>
  <div class="row">
    <label>Compa√±√≠a:</label>
    <select id="companySelect">
      <option value="">‚Äî Sin seleccionar (token por defecto) ‚Äî</option>
      <option value="+15550000001">Compa√±√≠a 2 ‚Äî All Blinds Inc</option>
      <option value="+15550000002">Compa√±√≠a 163 ‚Äî ai_agent_callcenter</option>
      <option value="+15550000003">Compa√±√≠a 387 ‚Äî karla1@blindsbook.com</option>
    </select>
  </div>
  <div class="row">
    <label>Servidor:</label>
    <input type="text" id="serverUrl" value="http://localhost:4000" />
  </div>
  <div class="row">
    <label>Caller ID:</label>
    <input type="text" id="callerPhone" value="+15551234567" placeholder="+1XXXXXXXXXX (simula From del cliente)" />
  </div>
  <div class="row">
    <label>Modo:</label>
    <div class="mode-toggle">
      <button id="modeVoice" class="active" onclick="setMode('voice')">üé§ Voz</button>
      <button id="modeText" onclick="setMode('text')">‚å®Ô∏è Texto</button>
    </div>
    <button class="btn btn-sm btn-primary" onclick="resetConversationFull()">üîÑ Nueva conversaci√≥n</button>
  </div>
</div>

<!-- LANGUAGE SELECTION -->
<div class="panel lang-panel" id="langPanel">
  <h2>üåê Paso 1 ‚Äî Selecciona el Idioma</h2>
  <p>Esto inicia la conversaci√≥n y env√≠a la selecci√≥n de idioma a la IA</p>
  <div class="lang-buttons">
    <button class="btn-lang" id="btnLangEs" onclick="startWithLanguage('1')">
      <span class="flag">üá™üá∏</span> Espa√±ol ‚Äî Presione 1
    </button>
    <button class="btn-lang" id="btnLangEn" onclick="startWithLanguage('2')">
      <span class="flag">üá∫üá∏</span> English ‚Äî Press 2
    </button>
  </div>
</div>

<!-- STATUS -->
<div class="panel">
  <div id="status" class="status idle">Listo ‚Äî Busca un cliente arriba, luego selecciona el idioma</div>
  <div class="state-bar" id="stateBar"></div>
</div>

<!-- CONTROLS -->
<div class="panel">
  <div class="controls" id="voiceControls">
    <button class="btn btn-record" id="btnRecord" onclick="toggleRecording()">
      üé§ Mant√©n presionado para hablar
    </button>
  </div>
  <div class="row" id="textInput">
    <input type="text" id="txtMsg" placeholder="Escribe tu mensaje..." onkeydown="if(event.key==='Enter')sendText()" />
    <button class="btn btn-primary btn-sm" onclick="sendText()">Enviar</button>
  </div>
</div>

<!-- TRANSCRIPT -->
<div class="panel">
  <h2>üí¨ Conversaci√≥n</h2>
  <div class="transcript" id="transcript"></div>
</div>

<!-- INFO -->
<div class="panel info">
  <b>¬øC√≥mo funciona?</b><br>
  1. Ingresa el <b>tel√©fono del cliente</b> y presiona <b>Buscar</b> ‚Äî se consultan las compa√±√≠as configuradas en el sistema.<br>
  2. Si se encuentra, ver√°s los datos del cliente y la configuraci√≥n se aplica autom√°ticamente (<b>toNumber</b> y <b>Caller ID</b>).<br>
  3. Presiona <b>üé§</b> y habla (o usa el modo Texto) ‚Äî la IA identifica al cliente y gestiona la cita.<br>
  4. El audio se reproduce autom√°ticamente ‚Äî escuchar√°s la respuesta de la recepcionista.<br>
  5. Repite hasta completar la cita.<br><br>
  <b>Compa√±√≠as configuradas:</b> 2 (All Blinds Inc), 163 (ai_agent_callcenter), 387 (karla1).<br>
  <b>Requisitos:</b> Chrome o Edge (Web Speech API). Micr√≥fono activo. Servicios en puertos 4000 + 8000.
</div>

<script>
const API = () => document.getElementById('serverUrl').value.replace(/\/$/,'');
let callId = 'voice-' + Date.now();
let mode = 'voice';
let recognition = null;
let isRecording = false;
let isPlaying = false;
let currentAudio = null;
let lastLookupResult = null; // last successful customer lookup
let speechRetryCount = 0;
const MAX_SPEECH_RETRIES = 2;

// ‚îÄ‚îÄ‚îÄ Customer Lookup ‚îÄ‚îÄ‚îÄ
async function lookupCustomer() {
  const phoneInput = document.getElementById('customerPhone');
  const phone = phoneInput.value.trim();
  if (!phone || phone.length < 3) {
    setLookupStatus('notfound', '‚ö†Ô∏è Ingresa al menos 3 caracteres del tel√©fono');
    return;
  }

  const btn = document.getElementById('btnSearch');
  btn.disabled = true;
  btn.textContent = '‚è≥ Buscando...';
  setLookupStatus('searching', `üîç Buscando "${phone}" en compa√±√≠as configuradas...`);
  hideCustomerCard();

  try {
    const resp = await fetch(API() + '/debug/customer-lookup?phone=' + encodeURIComponent(phone));
    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
    const data = await resp.json();

    if (data.results && data.results.length > 0) {
      const customer = data.results[0]; // pick first match
      lastLookupResult = customer;
      showCustomerCard(customer, data.results.length, data.companiesSearched);

      // Auto-configure: set toNumber and callerPhone
      document.getElementById('companySelect').value = customer.twilioNumber;
      document.getElementById('callerPhone').value = customer.phone || phone;

      setLookupStatus('found', `‚úÖ Encontrado: ${data.results.length} resultado(s) en ${data.companiesSearched.length} compa√±√≠a(s)`);
    } else {
      setLookupStatus('notfound', `‚ùå No encontrado en compa√±√≠as configuradas (${data.companiesSearched.join(', ')}). Verifica el n√∫mero o configura m√°s compa√±√≠as.`);
    }
  } catch (err) {
    setLookupStatus('notfound', '‚ùå Error: ' + err.message + ' ‚Äî ¬øEl servidor est√° corriendo?');
  } finally {
    btn.disabled = false;
    btn.textContent = 'üîç Buscar';
  }
}

function setLookupStatus(cls, text) {
  const el = document.getElementById('lookupStatus');
  el.className = cls;
  el.textContent = text;
}

function showCustomerCard(customer, totalResults, companiesSearched) {
  const card = document.getElementById('customerCard');
  const fullName = [customer.firstName, customer.lastName].filter(Boolean).join(' ') || '‚Äî';
  
  document.getElementById('cardCustomerName').textContent = 'üë§ ' + fullName;
  document.getElementById('cardCompanyBadge').textContent = 'Compa√±√≠a ' + customer.companyId;

  const grid = document.getElementById('customerGrid');
  grid.innerHTML = '';

  const fields = [
    { label: 'ID Cliente', value: customer.id, highlight: true },
    { label: 'Compa√±√≠a', value: customer.companyName || 'N/A' },
    { label: 'Nombre', value: customer.firstName || '‚Äî' },
    { label: 'Apellido', value: customer.lastName || '‚Äî' },
    { label: 'Tel√©fono', value: customer.phone || '‚Äî', highlight: true },
    { label: 'Account Manager ID', value: customer.accountManagerId || 'Sin asignar' },
    { label: 'Company ID (BD)', value: customer.companyId },
    { label: 'Twilio Number', value: customer.twilioNumber },
  ];

  for (const f of fields) {
    const div = document.createElement('div');
    div.className = 'field';
    div.innerHTML = `<span class="lbl">${f.label}</span><span class="val${f.highlight ? ' highlight' : ''}">${f.value}</span>`;
    grid.appendChild(div);
  }

  // Show auto-config message
  const configMsg = document.getElementById('configAutoMsg');
  configMsg.style.display = 'block';
  document.getElementById('autoToNumber').textContent = customer.twilioNumber + ' ‚Üí Compa√±√≠a ' + customer.companyId;
  document.getElementById('autoFromNumber').textContent = customer.phone || document.getElementById('callerPhone').value;

  card.className = 'customer-card visible';
}

function hideCustomerCard() {
  document.getElementById('customerCard').className = 'customer-card';
  document.getElementById('configAutoMsg').style.display = 'none';
}

// ‚îÄ‚îÄ‚îÄ Web Speech API (STT del navegador ‚Äî gratis) ‚îÄ‚îÄ‚îÄ
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
if (!SpeechRecognition) {
  document.getElementById('status').textContent = '‚ö†Ô∏è Tu navegador no soporta Web Speech API. Usa Chrome o Edge.';
  document.getElementById('status').className = 'status error';
  document.getElementById('btnRecord').disabled = true;
}

function setMode(m) {
  mode = m;
  document.getElementById('modeVoice').className = m==='voice'?'active':'';
  document.getElementById('modeText').className = m==='text'?'active':'';
  document.getElementById('voiceControls').style.display = m==='voice'?'flex':'none';
  document.getElementById('textInput').className = m==='text'?'row active':'row';
  if (m==='text') document.getElementById('txtMsg').focus();
}

function resetConversation() {
  callId = 'voice-' + Date.now();
  document.getElementById('transcript').innerHTML = '';
  updateState(null);
  setStatus('idle', 'Nueva conversaci√≥n iniciada');
  // Trigger initial greeting
  sendToServer(null);
}

function getToNumber() {
  return document.getElementById('companySelect').value || null;
}

// ‚îÄ‚îÄ‚îÄ Recording ‚îÄ‚îÄ‚îÄ
function toggleRecording() {
  if (isPlaying) return;
  if (isRecording) {
    stopRecording();
  } else {
    startRecording();
  }
}

function startRecording() {
  if (!SpeechRecognition) return;
  
  recognition = new SpeechRecognition();
  recognition.lang = 'es-ES';
  recognition.interimResults = false;
  recognition.maxAlternatives = 1;
  recognition.continuous = false;
  
  recognition.onresult = (event) => {
    const text = event.results[0][0].transcript;
    const confidence = event.results[0][0].confidence;
    addMessage('user', text, `Confianza: ${(confidence*100).toFixed(0)}%`);
    sendToServer(text);
  };
  
  recognition.onerror = (event) => {
    console.warn('Speech error:', event.error);
    if (event.error === 'no-speech') {
      setStatus('idle', 'No se detect√≥ voz ‚Äî intenta de nuevo');
    } else if (event.error === 'not-allowed') {
      setStatus('error', '‚ö†Ô∏è Permiso de micr√≥fono denegado. Permite el acceso en tu navegador.');
    } else if (event.error === 'network') {
      // Edge uses cloud speech services ‚Äî retry automatically
      if (speechRetryCount < MAX_SPEECH_RETRIES) {
        speechRetryCount++;
        setStatus('listening', `üîÑ Reconectando al servicio de voz (intento ${speechRetryCount}/${MAX_SPEECH_RETRIES})...`);
        isRecording = false;
        setTimeout(() => startRecording(), 800);
        return;
      }
      speechRetryCount = 0;
      setStatus('error', '‚ö†Ô∏è Error de red en reconocimiento de voz. Edge requiere conexi√≥n a Internet para STT. Cambiando a modo Texto...');
      // Auto-switch to text mode after network failure
      setTimeout(() => setMode('text'), 1500);
    } else if (event.error === 'audio-capture') {
      setStatus('error', '‚ö†Ô∏è No se detect√≥ micr√≥fono. Verifica que est√© conectado y permitido.');
    } else if (event.error === 'aborted') {
      setStatus('idle', 'Reconocimiento cancelado');
    } else {
      setStatus('error', `Error de reconocimiento: ${event.error}. Prueba con modo Texto.`);
    }
    isRecording = false;
    updateRecordButton();
  };
  
  recognition.onend = () => {
    isRecording = false;
    updateRecordButton();
  };
  
  try {
    recognition.start();
    isRecording = true;
    speechRetryCount = 0;
    updateRecordButton();
    setStatus('listening', 'üé§ Escuchando... Habla ahora');
  } catch(e) {
    if (e.message && e.message.includes('already started')) {
      // Edge sometimes throws if recognition is already running
      return;
    }
    setStatus('error', 'No se pudo iniciar el micr√≥fono: ' + e.message);
  }
}

function stopRecording() {
  if (recognition) {
    recognition.stop();
  }
  isRecording = false;
  updateRecordButton();
}

function updateRecordButton() {
  const btn = document.getElementById('btnRecord');
  if (isRecording) {
    btn.className = 'btn btn-record recording';
    btn.innerHTML = 'üî¥ Escuchando... (click para detener)';
  } else if (isPlaying) {
    btn.className = 'btn btn-record';
    btn.innerHTML = 'üîä IA hablando...';
    btn.disabled = true;
  } else {
    btn.className = 'btn btn-record';
    btn.innerHTML = 'üé§ Presiona para hablar';
    btn.disabled = false;
  }
}

// ‚îÄ‚îÄ‚îÄ Text mode ‚îÄ‚îÄ‚îÄ
function sendText() {
  const input = document.getElementById('txtMsg');
  const text = input.value.trim();
  if (!text) return;
  input.value = '';
  addMessage('user', text);
  sendToServer(text);
}

// ‚îÄ‚îÄ‚îÄ Server communication ‚îÄ‚îÄ‚îÄ
async function sendToServer(text) {
  setStatus('speaking', '‚è≥ Procesando...');
  
  const body = { callId, text, toNumber: getToNumber(), fromNumber: document.getElementById('callerPhone').value || null };
  
  try {
    const resp = await fetch(API() + '/debug/voice-chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body),
    });
    
    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
    
    const data = await resp.json();
    
    const meta = `Step: ${data.state.step} | TTS: ${data.ttsProvider}`;
    addMessage('ia', data.replyText, meta);
    updateState(data.state);
    
    // Update customer card with real-time state info if we have a customer match
    if (data.state.customerId && lastLookupResult) {
      updateRealTimeState(data.state);
    }
    
    // Play audio
    if (data.audioBase64) {
      await playAudioBase64(data.audioBase64);
    } else {
      setStatus('idle', 'Sin audio TTS ‚Äî respuesta solo texto');
    }
    
    if (data.isFinished) {
      addMessage('ia', '‚úÖ Conversaci√≥n finalizada. Presiona "Nueva conversaci√≥n" para empezar otra.', 'Sistema');
      setStatus('idle', '‚úÖ Cita gestionada ‚Äî conversaci√≥n terminada');
    }
    
  } catch(err) {
    setStatus('error', '‚ùå Error: ' + err.message);
    addMessage('ia', '‚ö†Ô∏è Error al contactar el servidor: ' + err.message, 'Error');
  }
}

function updateRealTimeState(state) {
  // Add live state fields to the customer card
  const grid = document.getElementById('customerGrid');
  // Remove previous live fields
  grid.querySelectorAll('.live-field').forEach(el => el.remove());

  const liveFields = [
    state.customerId ? { label: '‚úì IDENTIFICADO (ID)', value: state.customerId } : null,
    state.customerConfirmedName ? { label: '‚úì NOMBRE CONFIRMADO', value: state.customerConfirmedName } : null,
    state.type !== null ? { label: 'TIPO CITA', value: ['Cotizaci√≥n','Instalaci√≥n','Reparaci√≥n'][state.type] } : null,
    state.startDateISO ? { label: 'FECHA CITA', value: new Date(state.startDateISO).toLocaleString('es-ES') } : null,
    state.duration ? { label: 'DURACI√ìN', value: state.duration } : null,
  ].filter(Boolean);

  for (const f of liveFields) {
    const div = document.createElement('div');
    div.className = 'field live-field';
    div.innerHTML = `<span class="lbl" style="color:#22c55e">${f.label}</span><span class="val highlight">${f.value}</span>`;
    grid.appendChild(div);
  }
}

// ‚îÄ‚îÄ‚îÄ Audio playback ‚îÄ‚îÄ‚îÄ
function playAudioBase64(b64) {
  return new Promise((resolve) => {
    if (currentAudio) {
      currentAudio.pause();
      currentAudio = null;
    }
    
    const audioSrc = 'data:audio/mpeg;base64,' + b64;
    const audio = new Audio(audioSrc);
    currentAudio = audio;
    isPlaying = true;
    updateRecordButton();
    setStatus('speaking', 'üîä IA hablando...');
    
    audio.onended = () => {
      isPlaying = false;
      currentAudio = null;
      updateRecordButton();
      setStatus('idle', 'Tu turno ‚Äî presiona üé§ para hablar');
      resolve();
    };
    
    audio.onerror = (e) => {
      console.warn('Audio playback error:', e);
      isPlaying = false;
      currentAudio = null;
      updateRecordButton();
      setStatus('idle', 'Audio no reproducido ‚Äî tu turno');
      resolve();
    };
    
    audio.play().catch(err => {
      console.warn('Autoplay blocked:', err);
      isPlaying = false;
      updateRecordButton();
      setStatus('idle', '‚ö†Ô∏è Click en la p√°gina primero (autoplay bloqueado) ‚Äî tu turno');
      resolve();
    });
  });
}

// ‚îÄ‚îÄ‚îÄ UI helpers ‚îÄ‚îÄ‚îÄ
function addMessage(role, text, meta) {
  const div = document.createElement('div');
  div.className = 'msg ' + role;
  div.innerHTML = text.replace(/\n/g, '<br>');
  if (meta) {
    const m = document.createElement('div');
    m.className = 'meta';
    m.textContent = meta;
    div.appendChild(m);
  }
  const container = document.getElementById('transcript');
  container.appendChild(div);
  container.scrollTop = container.scrollHeight;
}

function setStatus(cls, text) {
  const el = document.getElementById('status');
  el.className = 'status ' + cls;
  el.textContent = text;
}

function updateState(state) {
  const bar = document.getElementById('stateBar');
  if (!state) { bar.innerHTML = ''; return; }
  bar.innerHTML = [
    `<span class="chip"><b>Step:</b> ${state.step}</span>`,
    `<span class="chip"><b>Lang:</b> ${state.language}</span>`,
    state.callerPhone ? `<span class="chip"><b>From:</b> ${state.callerPhone}</span>` : '',
    state.type !== null ? `<span class="chip"><b>Tipo:</b> ${['Cotizaci√≥n','Instalaci√≥n','Reparaci√≥n'][state.type]}</span>` : '',
    state.customerId ? `<span class="chip"><b>ClienteID:</b> ${state.customerId}</span>` : '',
    state.customerConfirmedName ? `<span class="chip"><b>Cliente:</b> ${state.customerConfirmedName}</span>` :
      state.customerNameSpoken ? `<span class="chip"><b>Cliente:</b> ${state.customerNameSpoken}</span>` : '',
    state.identificationAttempts > 0 ? `<span class="chip"><b>Intentos:</b> ${state.identificationAttempts}/3</span>` : '',
    state.startDateISO ? `<span class="chip"><b>Fecha:</b> ${new Date(state.startDateISO).toLocaleString('es-ES')}</span>` : '',
    state.duration ? `<span class="chip"><b>Duraci√≥n:</b> ${state.duration}</span>` : '',
  ].filter(Boolean).join('');
}

// ‚îÄ‚îÄ‚îÄ Language selection ‚Üí starts conversation ‚îÄ‚îÄ‚îÄ
async function startWithLanguage(langChoice) {
  const btnEs = document.getElementById('btnLangEs');
  const btnEn = document.getElementById('btnLangEn');
  btnEs.disabled = true;
  btnEn.disabled = true;
  setStatus('speaking', '‚è≥ Iniciando conversaci√≥n...');

  // 1. Send null to get the initial greeting ("Para espa√±ol presione 1...")
  await sendToServer(null);

  // 2. Small delay then send language choice
  await new Promise(r => setTimeout(r, 500));
  addMessage('user', langChoice === '1' ? 'Espa√±ol (1)' : 'English (2)', 'Selecci√≥n de idioma');
  await sendToServer(langChoice);

  // 3. Hide language panel ‚Äî conversation is active
  document.getElementById('langPanel').className = 'panel lang-panel done';
}

function resetConversationFull() {
  resetConversation();
  // Show language panel again
  document.getElementById('langPanel').className = 'panel lang-panel';
  document.getElementById('btnLangEs').disabled = false;
  document.getElementById('btnLangEn').disabled = false;
  lastLookupResult = null;
  hideCustomerCard();
}

// ‚îÄ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ
window.addEventListener('load', () => {
  document.getElementById('customerPhone').focus();
});
</script>
</body>
</html>
